package com.company.${NAMESPACE}.${MODULE_NAME}.otel;

import io.opentelemetry.api.trace.Span;
import io.opentelemetry.api.trace.SpanContext;
import io.opentelemetry.api.trace.TraceFlags;
import io.opentelemetry.api.trace.TraceState;
import io.opentelemetry.context.Context;
import org.apache.kafka.clients.consumer.ConsumerRecord;
import org.apache.kafka.common.header.internals.RecordHeaders;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

import java.nio.charset.StandardCharsets;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

/**
 * Telemetry validation tests for ${SERVICE_NAME}.
 *
 * These tests verify:
 * - OTel spans are created correctly
 * - Trace context is propagated via Kafka headers
 * - x-obs-* correlation headers are extracted
 *
 * Generated by: Instrumentation Autopilot
 * Diff Plan ID: ${DIFF_PLAN_ID}
 */
@ExtendWith(MockitoExtension.class)
class ${CLASS_NAME}OtelInterceptorTest {

    private static final String TEST_TOPIC = "${INPUT_TOPIC}";
    private static final String TEST_SERVICE = "${SERVICE_NAME}";
    private static final String TEST_CONSUMER_GROUP = "${CONSUMER_GROUP}";

    private ${CLASS_NAME}OtelInterceptor interceptor;

    @BeforeEach
    void setUp() {
        interceptor = new ${CLASS_NAME}OtelInterceptor();
        interceptor.configure(java.util.Map.of());
    }

    @Test
    void shouldCreateConsumerSpanForMessage() {
        // Given
        RecordHeaders headers = new RecordHeaders();
        headers.add("traceparent", "00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01".getBytes(StandardCharsets.UTF_8));

        ConsumerRecord<String, String> record = new ConsumerRecord<>(
            TEST_TOPIC,
            0,
            100L,
            "key",
            "value"
        );
        record.headers().add("traceparent", headers.lastHeader("traceparent").value());

        // When
        var records = new org.apache.kafka.clients.consumer.ConsumerRecords<>(
            java.util.Map.of(
                new org.apache.kafka.common.TopicPartition(TEST_TOPIC, 0),
                java.util.List.of(record)
            )
        );

        var result = interceptor.onConsume(records);

        // Then
        assertNotNull(result);
        assertEquals(1, result.count());
    }

    @Test
    void shouldExtractObservabilityHeaders() {
        // Given
        RecordHeaders headers = new RecordHeaders();
        headers.add("x-obs-dataproduct-urn", "${SERVICE_URN}".getBytes(StandardCharsets.UTF_8));
        headers.add("x-obs-schema-id", "${SCHEMA_ID}".getBytes(StandardCharsets.UTF_8));

        ConsumerRecord<String, String> record = new ConsumerRecord<>(
            TEST_TOPIC,
            0,
            100L,
            "key",
            "value"
        );
        for (var header : headers) {
            record.headers().add(header);
        }

        // When
        var records = new org.apache.kafka.clients.consumer.ConsumerRecords<>(
            java.util.Map.of(
                new org.apache.kafka.common.TopicPartition(TEST_TOPIC, 0),
                java.util.List.of(record)
            )
        );

        var result = interceptor.onConsume(records);

        // Then
        assertNotNull(result);
        // Verify headers were processed (span attributes would be set)
    }

    @Test
    void shouldHandleMessagesWithoutTraceContext() {
        // Given - no traceparent header
        ConsumerRecord<String, String> record = new ConsumerRecord<>(
            TEST_TOPIC,
            0,
            100L,
            "key",
            "value"
        );

        // When
        var records = new org.apache.kafka.clients.consumer.ConsumerRecords<>(
            java.util.Map.of(
                new org.apache.kafka.common.TopicPartition(TEST_TOPIC, 0),
                java.util.List.of(record)
            )
        );

        // Then - should not throw
        assertDoesNotThrow(() -> interceptor.onConsume(records));
    }

    @Test
    void shouldSetCorrectSpanAttributes() {
        // This test would use OpenTelemetry SDK testing utilities
        // to verify span attributes are set correctly

        // Given
        ConsumerRecord<String, String> record = new ConsumerRecord<>(
            TEST_TOPIC,
            0,
            100L,
            "key",
            "value"
        );

        var records = new org.apache.kafka.clients.consumer.ConsumerRecords<>(
            java.util.Map.of(
                new org.apache.kafka.common.TopicPartition(TEST_TOPIC, 0),
                java.util.List.of(record)
            )
        );

        // When
        interceptor.onConsume(records);

        // Then
        // With proper OTel SDK testing, verify:
        // - span.name = "consume ${INPUT_TOPIC}"
        // - messaging.system = "kafka"
        // - messaging.destination = TEST_TOPIC
        // - messaging.kafka.consumer_group = TEST_CONSUMER_GROUP
        // - service.name = TEST_SERVICE
    }
}
