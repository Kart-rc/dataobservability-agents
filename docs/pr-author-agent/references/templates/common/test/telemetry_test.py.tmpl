"""
Telemetry validation tests for ${SERVICE_NAME}.

These tests verify:
- OTel spans are created correctly
- Trace context is propagated via Kafka headers
- x-obs-* correlation headers are extracted

Generated by: Instrumentation Autopilot
Diff Plan ID: ${DIFF_PLAN_ID}
"""

import pytest
from unittest.mock import Mock, patch, MagicMock
from opentelemetry import trace
from opentelemetry.sdk.trace import TracerProvider
from opentelemetry.sdk.trace.export.in_memory_span_exporter import InMemorySpanExporter


# Test constants
TEST_TOPIC = "${INPUT_TOPIC}"
TEST_SERVICE = "${SERVICE_NAME}"
TEST_CONSUMER_GROUP = "${CONSUMER_GROUP}"
TEST_SERVICE_URN = "${SERVICE_URN}"


@pytest.fixture
def tracer_provider():
    """Set up OTel tracer with in-memory exporter for testing."""
    exporter = InMemorySpanExporter()
    provider = TracerProvider()
    provider.add_span_processor(
        trace.get_tracer_provider().get_tracer(__name__)
    )
    trace.set_tracer_provider(provider)
    yield provider, exporter
    exporter.clear()


@pytest.fixture
def mock_message():
    """Create a mock Kafka message."""
    message = Mock()
    message.topic.return_value = TEST_TOPIC
    message.partition.return_value = 0
    message.offset.return_value = 100
    message.key.return_value = b"test-key"
    message.value.return_value = b"test-value"
    message.headers.return_value = [
        ("traceparent", b"00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01"),
        ("x-obs-dataproduct-urn", TEST_SERVICE_URN.encode()),
    ]
    return message


class TestOtelKafkaWrapper:
    """Test suite for OTel Kafka wrapper instrumentation."""

    def test_consumer_span_created(self, mock_message):
        """Verify consumer span is created for incoming message."""
        from otel_kafka_wrapper import trace_consumer

        @trace_consumer
        def process_message(message):
            return "processed"

        result = process_message(mock_message)

        assert result == "processed"
        # In real test, verify span was created with correct attributes

    def test_trace_context_extraction(self, mock_message):
        """Verify trace context is extracted from Kafka headers."""
        from otel_kafka_wrapper import extract_context

        ctx = extract_context(mock_message)

        # Context should contain parent span info from traceparent header
        assert ctx is not None

    def test_correlation_headers_extraction(self, mock_message):
        """Verify x-obs-* headers are extracted as span attributes."""
        from otel_kafka_wrapper import trace_consumer

        captured_span = None

        @trace_consumer
        def process_message(message):
            nonlocal captured_span
            captured_span = trace.get_current_span()
            return "processed"

        process_message(mock_message)

        # Verify x-obs-dataproduct-urn was extracted
        # In real test with proper setup, check span attributes

    def test_producer_span_created(self):
        """Verify producer span is created when sending message."""
        from otel_kafka_wrapper import trace_producer

        @trace_producer(TEST_TOPIC)
        def send_message(key, value):
            return "sent"

        result = send_message("key", "value")

        assert result == "sent"

    def test_producer_injects_trace_context(self):
        """Verify trace context is injected into outgoing headers."""
        from otel_kafka_wrapper import inject_context

        headers = inject_context(trace.get_current_span().get_span_context())

        # Should have traceparent header
        header_keys = [h[0] for h in headers]
        assert "x-obs-dataproduct-urn" in header_keys

    def test_instrumented_consumer_polls(self):
        """Verify InstrumentedConsumer polls messages with tracing."""
        from otel_kafka_wrapper import InstrumentedConsumer

        mock_consumer = Mock()
        mock_consumer.poll.return_value = None

        # Would need to mock more for full test
        # consumer = InstrumentedConsumer({"bootstrap.servers": "localhost:9092"})

    def test_instrumented_producer_sends(self):
        """Verify InstrumentedProducer sends messages with tracing."""
        from otel_kafka_wrapper import InstrumentedProducer

        # Would need to mock confluent_kafka.Producer
        # producer = InstrumentedProducer({"bootstrap.servers": "localhost:9092"})


class TestSpanAttributes:
    """Test that correct span attributes are set."""

    def test_consumer_span_has_required_attributes(self, mock_message):
        """Verify consumer span has all required OTel semantic conventions."""
        from otel_kafka_wrapper import trace_consumer

        @trace_consumer
        def process_message(message):
            span = trace.get_current_span()
            # In real test, verify attributes:
            # - messaging.system = "kafka"
            # - messaging.destination = TEST_TOPIC
            # - messaging.kafka.consumer_group = TEST_CONSUMER_GROUP
            # - service.name = TEST_SERVICE
            return "processed"

        process_message(mock_message)

    def test_producer_span_has_required_attributes(self):
        """Verify producer span has all required OTel semantic conventions."""
        from otel_kafka_wrapper import trace_producer

        @trace_producer(TEST_TOPIC)
        def send_message():
            span = trace.get_current_span()
            # In real test, verify attributes:
            # - messaging.system = "kafka"
            # - messaging.destination = TEST_TOPIC
            # - service.name = TEST_SERVICE
            return "sent"

        send_message()


class TestErrorHandling:
    """Test error handling in instrumentation."""

    def test_consumer_records_exception(self, mock_message):
        """Verify exceptions are recorded in consumer span."""
        from otel_kafka_wrapper import trace_consumer

        @trace_consumer
        def process_message(message):
            raise ValueError("Processing failed")

        with pytest.raises(ValueError):
            process_message(mock_message)

        # In real test, verify span has error status and exception recorded

    def test_producer_records_exception(self):
        """Verify exceptions are recorded in producer span."""
        from otel_kafka_wrapper import trace_producer

        @trace_producer(TEST_TOPIC)
        def send_message():
            raise ConnectionError("Kafka unavailable")

        with pytest.raises(ConnectionError):
            send_message()

        # In real test, verify span has error status and exception recorded


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
